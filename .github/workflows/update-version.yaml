name: Sync Upstream PR

on:
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream tag to merge (e.g. v1.2.3)"
        required: true
      target_branch:
        description: "Target branch in your fork"
        default: "main"
        required: false
      merge_strategy:
        description: "Merge strategy (ours, theirs, or leave empty for default)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout origin repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/danny-avila/LibreChat.git
          
          # Fetch the specific tag with enough history to find common ancestor
          echo "Fetching upstream tag: ${{ github.event.inputs.upstream_tag }}"
          git fetch upstream --tags --depth=1000
          
          # Also fetch upstream main for reference  
          git fetch upstream main --depth=1000

      - name: Validate upstream tag
        id: validate_tag
        run: |
          TAG="${{ github.event.inputs.upstream_tag }}"
          echo "Checking if tag '$TAG' exists in upstream..."
          
          # Check if tag exists
          if git ls-remote --tags upstream | grep -q "refs/tags/$TAG"; then
            echo "Tag '$TAG' found in upstream"
            # Get the commit SHA for the tag
            SHA=$(git ls-remote --tags upstream "refs/tags/$TAG" | cut -f1)
            echo "tag_sha=$SHA" >> $GITHUB_OUTPUT
            echo "Tag SHA: $SHA"
          else
            echo "::error::Tag '$TAG' not found in upstream repository"
            exit 1
          fi

      - name: Check for workflow changes
        id: check_workflows
        run: |
          TAG="${{ github.event.inputs.upstream_tag }}"
          echo "Checking for workflow changes in upstream tag..."
          
          # Get the list of workflow files that changed in the upstream tag
          WORKFLOW_CHANGES=$(git diff --name-only HEAD..$TAG -- .github/workflows/ 2>/dev/null || true)
          
          if [ -n "$WORKFLOW_CHANGES" ]; then
            echo "workflow_changes=true" >> $GITHUB_OUTPUT
            echo "Workflow changes detected:"
            echo "$WORKFLOW_CHANGES"
            
            # Save the changes to a file for the summary
            echo "# Workflow Changes Detected" > WORKFLOW_CHANGES.md
            echo "" >> WORKFLOW_CHANGES.md
            echo "‚ö†Ô∏è **The upstream tag \`$TAG\` contains changes to GitHub workflows that were excluded from this merge.**" >> WORKFLOW_CHANGES.md
            echo "" >> WORKFLOW_CHANGES.md
            echo "## Changed workflow files:" >> WORKFLOW_CHANGES.md
            echo "\`\`\`" >> WORKFLOW_CHANGES.md
            echo "$WORKFLOW_CHANGES" >> WORKFLOW_CHANGES.md
            echo "\`\`\`" >> WORKFLOW_CHANGES.md
            echo "" >> WORKFLOW_CHANGES.md
            echo "## What to do:" >> WORKFLOW_CHANGES.md
            echo "1. Review the workflow changes manually" >> WORKFLOW_CHANGES.md
            echo "2. If you want to include them, manually cherry-pick or apply the changes" >> WORKFLOW_CHANGES.md
            echo "3. Test workflow changes in a separate PR for safety" >> WORKFLOW_CHANGES.md
            echo "" >> WORKFLOW_CHANGES.md
            echo "## To see the changes:" >> WORKFLOW_CHANGES.md
            echo "\`\`\`bash" >> WORKFLOW_CHANGES.md
            echo "git fetch upstream --tags" >> WORKFLOW_CHANGES.md
            echo "git diff HEAD..$TAG -- .github/workflows/" >> WORKFLOW_CHANGES.md
            echo "\`\`\`" >> WORKFLOW_CHANGES.md
          else
            echo "workflow_changes=false" >> $GITHUB_OUTPUT
            echo "No workflow changes detected in upstream tag"
          fi

      - name: Merge upstream tag
        id: merge_upstream
        continue-on-error: true
        run: |
          TAG="${{ github.event.inputs.upstream_tag }}"
          STRATEGY="${{ github.event.inputs.merge_strategy }}"
          
          echo "Merging upstream tag: $TAG"
          
          # Do the merge and commit normally - preserve the merge commit
          if [ -n "$STRATEGY" ]; then
            echo "Using merge strategy: $STRATEGY"
            git merge --no-ff -X "$STRATEGY" --allow-unrelated-histories "$TAG" -m "Merge upstream $TAG"
          else
            echo "Using default merge strategy"
            git merge --no-ff --allow-unrelated-histories "$TAG" -m "Merge upstream $TAG"
          fi
          
          # After the merge commit is created, check if we need to revert workflow files
          if [ "${{ steps.check_workflows.outputs.workflow_changes }}" = "true" ]; then
            echo "Detected workflow changes, creating a follow-up commit to revert them..."
            
            # Restore workflow files to target branch state
            git checkout "origin/${{ github.event.inputs.target_branch }}" -- .github/workflows/
            
            # Only commit if there are actually changes to revert
            if ! git diff --quiet .github/workflows/; then
              git add .github/workflows/
              git commit -m "Revert workflow changes for security - files from upstream $TAG reverted (review manually if needed)"
              echo "Workflow files reverted in separate commit"
            else
              echo "No workflow file changes to revert"
            fi
          fi
          
          echo "Merge completed with workflow handling"

      - name: Create sync branch and push
        id: create_branch
        run: |
          SYNC_BRANCH="sync/upstream-${{ github.event.inputs.upstream_tag }}-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
          
          # Create new branch from current state (after merge)
          git checkout -b "$SYNC_BRANCH"
          
          # Add sync summary file
          echo "# Upstream Sync Summary" > SYNC_SUMMARY.md
          echo "" >> SYNC_SUMMARY.md
          echo "- **Upstream tag**: ${{ github.event.inputs.upstream_tag }}" >> SYNC_SUMMARY.md
          echo "- **Target branch**: ${{ github.event.inputs.target_branch }}" >> SYNC_SUMMARY.md
          echo "- **Merge strategy**: ${{ github.event.inputs.merge_strategy || 'default' }}" >> SYNC_SUMMARY.md
          echo "- **Sync date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> SYNC_SUMMARY.md
          echo "- **Merge status**: ${{ steps.merge_upstream.outcome == 'failure' && 'Failed (conflicts)' || 'Success' }}" >> SYNC_SUMMARY.md
          echo "- **Workflow changes**: ${{ steps.check_workflows.outputs.workflow_changes == 'true' && '‚ö†Ô∏è Detected (excluded)' || '‚úÖ None' }}" >> SYNC_SUMMARY.md
          
          if [ "${{ steps.merge_upstream.outcome }}" = "success" ]; then
            echo "" >> SYNC_SUMMARY.md
            echo "‚úÖ **Clean merge completed successfully**" >> SYNC_SUMMARY.md
            echo "" >> SYNC_SUMMARY.md
            echo "The upstream changes have been successfully merged into this branch." >> SYNC_SUMMARY.md
          fi
          
          git add SYNC_SUMMARY.md
          
          # Add workflow changes file if it exists
          if [ -f WORKFLOW_CHANGES.md ]; then
            git add WORKFLOW_CHANGES.md
          fi
          
          git commit -m "docs: add sync summary for upstream ${{ github.event.inputs.upstream_tag }}"
          
          # Push the branch
          git push origin "$SYNC_BRANCH"
          
          echo "Created and pushed branch: $SYNC_BRANCH"

      - name: Create Pull Request with curl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create PR using direct API call which should work with standard token
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d '{
              "title": "üîÑ Sync upstream: ${{ github.event.inputs.upstream_tag }}",
              "body": "## Upstream Sync: ${{ github.event.inputs.upstream_tag }}\n\nThis PR syncs the upstream tag `${{ github.event.inputs.upstream_tag }}` from [danny-avila/LibreChat](https://github.com/danny-avila/LibreChat) into `${{ github.event.inputs.target_branch }}`.\n\n### Details\n- **Upstream tag**: `${{ github.event.inputs.upstream_tag }}`\n- **Target branch**: `${{ github.event.inputs.target_branch }}`\n- **Merge strategy**: `${{ github.event.inputs.merge_strategy || 'default' }}`\n- **Triggered by**: @${{ github.actor }}\n\n### Status\n${{ steps.merge_upstream.outcome == 'failure' && '‚ö†Ô∏è **Merge conflicts detected** - This PR requires manual resolution' || '‚úÖ **Clean merge** - Ready for review' }}\n\n${{ steps.check_workflows.outputs.workflow_changes == 'true' && '### ‚ö†Ô∏è Workflow Changes Detected\n\nThis upstream tag contains GitHub workflow changes that were **excluded** from this merge for security reasons. See the `WORKFLOW_CHANGES.md` file in this PR for details on what changed and how to review them manually.' || '' }}\n\n---\n*Automated upstream sync via GitHub Actions*",
              "head": "${{ steps.create_branch.outputs.branch_name }}",
              "base": "${{ github.event.inputs.target_branch }}",
              "draft": ${{ steps.merge_upstream.outcome == 'failure' }}
            }'
